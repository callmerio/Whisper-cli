# 知识卡片

## 报告排版

- 使用固定宽度边框（60 列）统一终端展示，便于快速扫描。
- 通过 `_session_report` 将阶段数据结构化，减少散落的 `print`。
- 当调试模式启用时，仍保留 `_show_replacement_stats` 与计时摘要。

## 接口自检

- 在服务启动前做一次轻量 API 探针，可以提前暴露 401 / 代理失效等问题。
- 统一在 `start()` 阶段阻断异常，避免录音后才发现鉴权失败。

## 用户无感录音

- 超时保护仍然存在，但移除录音中途的警告提示，保持沉浸体验。
- 短录音判定失败时不再弹出警告，仅静默回到待机。
- 自动粘贴只输出清洗后的最终文本，原始版不再提前粘贴。

## 代码安全最佳实践（2025-09-30）

### API 密钥安全

- **问题**：使用 SHA1 哈希且直接输出密钥片段存在安全隐患
- **方案**：升级到 SHA256，仅输出前 12 位指纹，在调试时显示
- **原则**：敏感信息永远不应完整输出到日志，哈希算法选择应符合当前安全标准

### 线程安全

- **问题**：全局变量在多线程环境下可能产生竞态条件
- **方案**：使用 `threading.Lock()` 保护全局状态的读写操作
- **原则**：任何共享状态都应有明确的同步机制，尤其是单例模式

### 错误处理分级

- **问题**：裸露的 `except Exception` 会掩盖真正的 bug
- **方案**：
  - 文件操作：捕获 `OSError`, `PermissionError`
  - JSON 解析：捕获 `JSONDecodeError`
  - 热键格式：捕获 `ValueError`
  - 未预期错误：在 DEBUG_MODE 下输出堆栈，生产环境简洁提示
- **原则**：捕获你能处理的异常，让无法处理的异常向上传播

### 配置管理

- **问题**：魔法数字散落在代码中，难以调整和维护
- **方案**：
  - 所有阈值、常量统一到 `config.py`
  - 添加行内注释解释每个配置的用途和推荐值
  - 实现 `validate_config()` 在启动时检查配置合法性
- **原则**：配置应该是显式的、可验证的、有文档的

### 类型注解与文档

- **问题**：缺少类型注解和文档字符串降低代码可读性
- **方案**：
  - 为所有公共函数添加完整的类型签名
  - 使用 Google 风格的文档字符串描述参数、返回值和可能的异常
  - 利用 `from __future__ import annotations` 支持前向引用
- **原则**：代码应该是自解释的，类型系统帮助编译器和人类理解意图

### 输入验证

- **问题**：未验证用户输入可能导致资源耗尽或注入攻击
- **方案**：
  - 文本长度限制（如 10000 字符上限）
  - 数值范围检查（如 `0 <= ratio <= 1`）
  - 路径存在性验证
- **原则**：永远不要信任外部输入，在边界处验证所有数据

### 服务初始化

- **问题**：单例模式初始化失败时返回未就绪对象导致后续崩溃
- **方案**：
  - 初始化失败时抛出明确的 `RuntimeError`
  - 记录所有初始化错误到列表供诊断
  - 提供 `reset()` 方法便于测试
- **原则**：失败要快速失败（Fail Fast），不要让错误传播到调用链深处

### 代码审查清单总结

遵循以下核心原则：

- **KISS**（Keep It Simple, Stupid）：简单胜过复杂
- **DRY**（Don't Repeat Yourself）：消除重复逻辑
- **YAGNI**（You Aren't Gonna Need It）：不做过度设计
- **SOLID**：单一职责、开放封闭、依赖倒置等面向对象设计原则
